<Window x:Class="Mintada.Navigator.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Mintada.Navigator"
        xmlns:vm="clr-namespace:Mintada.Navigator.ViewModels"
        xmlns:models="clr-namespace:Mintada.Navigator.Models"
        xmlns:converters="clr-namespace:Mintada.Navigator.Converters"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        mc:Ignorable="d"
        Title="Mintada Navigator" Height="800" Width="1200" x:Name="RootWindow" WindowState="Maximized">
    <Window.DataContext>
        <vm:MainViewModel />
    </Window.DataContext>
    
    <Window.Resources>
        <converters:RatioToPixelConverter x:Key="RatioToPixelConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:TabIndexToVisibilityConverter x:Key="TabIndexToVisibilityConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="600" />
            <ColumnDefinition Width="337" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- Left Panel: Tab Control -->
        <TabControl Grid.Column="0" SelectedIndex="{Binding SelectedTabIndex}">
            <TabControl.Resources>
                <!-- Style for tab headers -->
                <Style TargetType="TabItem">
                    <Setter Property="Padding" Value="15,8"/>
                    <Setter Property="FontSize" Value="13"/>
                    <Setter Property="FontWeight" Value="SemiBold"/>
                    <Setter Property="Cursor" Value="Hand"/>
                </Style>
            </TabControl.Resources>
            
            <!-- Coin Types Tab -->
            <TabItem Header="Coin Types">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    
                    <StackPanel Grid.Row="0" Margin="5">
                        <!-- Coin ID Filter with Label -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Coin ID:" VerticalAlignment="Center" Width="60" Foreground="#555"/>
                            <TextBox Text="{Binding SearchCoinIdText, UpdateSourceTrigger=PropertyChanged}" 
                                     Width="120" Padding="5" ToolTip="Search by Coin ID (Enter)" VerticalContentAlignment="Center">
                                <TextBox.InputBindings>
                                    <KeyBinding Key="Enter" Command="{Binding SearchByCoinIdCommand}"/>
                                </TextBox.InputBindings>
                            </TextBox>
                            <Button Command="{Binding SearchByCoinIdCommand}" Content="Go" Padding="10,0" Margin="5,0,0,0" Cursor="Hand"/>
                        </StackPanel>

                        <!-- Issuer Filter with Label -->
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="Issuer:" VerticalAlignment="Center" Width="60" Foreground="#555"/>
                            <TextBox Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}" 
                                     Width="200" Padding="5" ToolTip="Filter Issuers..." />
                        </StackPanel>
                        
                        <StackPanel Orientation="Horizontal">
                            <!-- Multiple Samples Filter -->
                            <ToggleButton IsChecked="{Binding IsNonReferenceFilterActive}" 
                                          Padding="4" Width="40" Height="40" Cursor="Hand"
                                          HorizontalAlignment="Left" ToolTip="Show Non-Reference Only">
                                 <ToggleButton.Style>
                                    <Style TargetType="ToggleButton">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ToggleButton">
                                                    <Border x:Name="border" Background="Transparent" CornerRadius="6" BorderThickness="1" BorderBrush="#EEEEEE" Margin="0,0,5,0">
                                                        <Image x:Name="img" Source="pack://siteoforigin:,,,/Resources/icon_filter_multiple.png" Margin="4" Opacity="0.4"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="border" Property="Background" Value="#F0F0F0"/>
                                                            <Setter TargetName="img" Property="Opacity" Value="0.7"/>
                                                        </Trigger>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Setter TargetName="border" Property="Background" Value="#E3F2FD"/> <!-- Selected Blue -->
                                                            <Setter TargetName="border" Property="BorderBrush" Value="#2196F3"/>
                                                            <Setter TargetName="img" Property="Opacity" Value="1.0"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ToggleButton.Style>
                            </ToggleButton>

                            <!-- Hide Fixed Filter -->
                            <ToggleButton IsChecked="{Binding IsHideFixedFilterActive}" 
                                          Padding="4" Width="40" Height="40" Cursor="Hand" Margin="0,0,5,0"
                                          HorizontalAlignment="Left" ToolTip="Hide Completed (Fixed)">
                                 <ToggleButton.Style>
                                    <Style TargetType="ToggleButton">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ToggleButton">
                                                    <Border x:Name="border" Background="Transparent" CornerRadius="6" BorderThickness="1" BorderBrush="#EEEEEE">
                                                        <Image x:Name="img" Source="pack://siteoforigin:,,,/Resources/icon_filter_hide_fixed.png" Margin="4" Opacity="0.4"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="border" Property="Background" Value="#F0F0F0"/>
                                                            <Setter TargetName="img" Property="Opacity" Value="0.7"/>
                                                        </Trigger>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Setter TargetName="border" Property="Background" Value="#FFEBEE"/> <!-- Light Red -->
                                                            <Setter TargetName="border" Property="BorderBrush" Value="#EF5350"/> <!-- Red -->
                                                            <Setter TargetName="img" Property="Opacity" Value="1.0"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ToggleButton.Style>
                            </ToggleButton>

                            <!-- Show Only Completed Filter -->
                            <ToggleButton IsChecked="{Binding IsShowCompletedFilterActive}" 
                                          Padding="4" Width="40" Height="40" Cursor="Hand"
                                          HorizontalAlignment="Left" ToolTip="Show Only Completed">
                                 <ToggleButton.Style>
                                    <Style TargetType="ToggleButton">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ToggleButton">
                                                    <Border x:Name="border" Background="Transparent" CornerRadius="6" BorderThickness="1" BorderBrush="#EEEEEE">
                                                        <Image x:Name="img" Source="pack://siteoforigin:,,,/Resources/icon_filter_fixed.png" Margin="4" Opacity="0.4"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="border" Property="Background" Value="#F0F0F0"/>
                                                            <Setter TargetName="img" Property="Opacity" Value="0.7"/>
                                                        </Trigger>
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Setter TargetName="border" Property="Background" Value="#E8F5E9"/> <!-- Selected Green -->
                                                            <Setter TargetName="border" Property="BorderBrush" Value="#4CAF50"/> <!-- Green -->
                                                            <Setter TargetName="img" Property="Opacity" Value="1.0"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ToggleButton.Style>
                            </ToggleButton>
                        </StackPanel>
                    </StackPanel>
                    
                    <TreeView Grid.Row="1" ItemsSource="{Binding Issuers}" SelectedItemChanged="TreeView_SelectedItemChanged">
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate DataType="{x:Type models:Issuer}" ItemsSource="{Binding Children}">
                                <TextBlock Text="{Binding Name}" />
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                        <TreeView.ItemContainerStyle>
                            <Style TargetType="TreeViewItem">
                                <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                                <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
                                <EventSetter Event="Selected" Handler="TreeViewItem_Selected" />
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="FontWeight" Value="Bold"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </TreeView.ItemContainerStyle>
                    </TreeView>
                </Grid>
            </TabItem>
            
            <!-- Rulers Tab -->
            <TabItem Header="Rulers">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    
                    <!-- Filter area (text filter only) -->
                    <StackPanel Grid.Row="0" Margin="5">
                        <TextBox Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}" 
                                 Padding="5" ToolTip="Filter Issuers..." Margin="0,0,0,5"/>
                    </StackPanel>
                    
                    <!-- Issuers TreeView (same as Coin Types tab) -->
                    <!-- Leaf Issuers List -->
                    <ListBox Grid.Row="1" ItemsSource="{Binding LeafIssuers}" 
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                             HorizontalContentAlignment="Stretch"
                             BorderThickness="0" Background="Transparent"
                             VirtualizingStackPanel.IsVirtualizing="True"
                             VirtualizingStackPanel.VirtualizationMode="Recycling">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Margin" Value="0"/>
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <Border Background="{TemplateBinding Background}"
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}">
                                                <ContentPresenter />
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#F5F5F5"/>
                                                </Trigger>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter Property="Background" Value="#E3F2FD"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate DataType="{x:Type vm:LeafIssuerViewModel}">
                                <Expander IsExpanded="{Binding IsExpanded, Mode=TwoWay}" Margin="0" Padding="5" 
                                          Background="Transparent" BorderThickness="0,0,0,1" BorderBrush="#EEE">
                                    <Expander.Header>
                                        <TextBlock Text="{Binding FullPath}" TextWrapping="Wrap" FontSize="13" FontWeight="Normal"/>
                                    </Expander.Header>
                                    <Expander.Content>
                                        <StackPanel Margin="24,0,0,10">
                                            <ProgressBar IsIndeterminate="True" Height="2" 
                                                         Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                         Margin="0,0,0,5"/>
                                            
                                            <ItemsControl ItemsSource="{Binding Rulers}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <StackPanel Margin="0,5">
                                                            <!-- Period Header -->
                                                            <TextBlock Text="{Binding Period}" FontWeight="Bold" Foreground="#1976D2" FontSize="12"
                                                                       Visibility="{Binding Period, Converter={StaticResource NullToVisibilityConverter}}"
                                                                       Margin="0,0,0,2"/>
                                                            
                                                            <ItemsControl ItemsSource="{Binding Rulers}">
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate>
                                                                        <Grid Margin="5,2">
                                                                            <Grid.ColumnDefinitions>
                                                                                <ColumnDefinition Width="Auto"/>
                                                                                <ColumnDefinition Width="*"/>
                                                                            </Grid.ColumnDefinitions>
                                                                            <TextBlock Text="•" Foreground="#999" Margin="0,0,5,0"/>
                                                                            <TextBlock Grid.Column="1" TextWrapping="Wrap">
                                                                                <Run Text="{Binding Name}" FontWeight="SemiBold"/>
                                                                                <Run Text="{Binding YearsText}" Foreground="Gray" FontSize="11"/>
                                                                            </TextBlock>
                                                                        </Grid>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                            </ItemsControl>
                                                        </StackPanel>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Expander.Content>
                                </Expander>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Middle Panel: Coins or Rulers -->
        <Grid Grid.Column="1" Background="#F0F0F0">
            <!-- Show Coins when Coin Types tab is selected -->
            <ListBox ItemsSource="{Binding Coins}" SelectedItem="{Binding SelectedCoin}" 
                     Visibility="{Binding SelectedTabIndex, Converter={StaticResource TabIndexToVisibilityConverter}, ConverterParameter=0}"
                     Margin="5" Background="Transparent" BorderThickness="0"
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                     SelectionChanged="CoinListBox_SelectionChanged">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="Padding" Value="1"/>
                        <Setter Property="Margin" Value="0,1"/>
                        <Setter Property="BorderThickness" Value="1"/>
                        <Setter Property="BorderBrush" Value="#AAAAAA"/>
                        <Setter Property="Cursor" Value="Hand"/>
                         <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <Border Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}">
                                        <ContentPresenter />
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#F2F2F2"/>
                                <Setter Property="BorderBrush" Value="#888888"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="#CCE8FF"/> 
                                <Setter Property="BorderBrush" Value="#2196F3"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="{x:Type models:CoinType}">
                        <Grid>
                            <StackPanel Margin="2">
                                <Grid Margin="0,0,2,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBox Grid.Column="0" Text="{Binding Id, Mode=OneWay}" IsReadOnly="True" 
                                             Background="Transparent" BorderThickness="0" 
                                             FontWeight="Bold" FontSize="14" Margin="0,0,2,0"/>
                                    
                                    <TextBlock Grid.Column="1" Text="-" FontSize="14" Margin="0,0,2,0"/>
                                    
                                    <TextBlock Grid.Column="2" FontSize="14" TextTrimming="CharacterEllipsis" TextWrapping="NoWrap" ToolTip="{Binding CoinTypeSlug}">
                                        <Hyperlink Command="{Binding DataContext.OpenCoinFolderCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                   CommandParameter="{Binding}">
                                            <Run Text="{Binding CoinTypeSlug}"/>
                                        </Hyperlink>
                                    </TextBlock>
                                </Grid>
                                
                                <!-- Reference Sample Display -->
                                <ContentControl Content="{Binding ReferenceSample}">
                                <ContentControl.ContentTemplate>
                                    <DataTemplate DataType="{x:Type models:CoinSample}">
                                        <Grid Margin="0,2,0,0" HorizontalAlignment="Left">
                                            <StackPanel Orientation="Horizontal">
                                                <!-- Obverse Image Grid -->
                                                <Grid Margin="0,0,2,0">
                                                    <Grid.Style>
                                                        <Style TargetType="Grid">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding HasObverse}" Value="False">
                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Grid.Style>

                                                    <Image Name="RefObvImg" Source="{Binding ObversePath, Converter={x:Static converters:PathToBitmapImageConverter.Instance}}" Height="150" />
                                                    
                                                    <Canvas IsHitTestVisible="False" Width="{Binding ActualWidth, ElementName=RefObvImg}" Height="{Binding ActualHeight, ElementName=RefObvImg}">
                                                        <Canvas.Style>
                                                            <Style TargetType="Canvas">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsCombinedImage}" Value="True">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Canvas.Style>
                                                        <Line Y1="0" Y2="{Binding ActualHeight, ElementName=RefObvImg}" Stroke="White" StrokeThickness="2" StrokeDashArray="4 2">
                                                            <Line.X1>
                                                                <MultiBinding Converter="{StaticResource RatioToPixelConverter}">
                                                                    <Binding Path="ActualWidth" ElementName="RefObvImg"/>
                                                                    <Binding Path="SplitRatio"/>
                                                                </MultiBinding>
                                                            </Line.X1>
                                                            <Line.X2>
                                                                <MultiBinding Converter="{StaticResource RatioToPixelConverter}">
                                                                    <Binding Path="ActualWidth" ElementName="RefObvImg"/>
                                                                    <Binding Path="SplitRatio"/>
                                                                </MultiBinding>
                                                            </Line.X2>
                                                        </Line>
                                                    </Canvas>
                                                </Grid>

                                                <!-- Reverse Image Grid -->
                                                <Grid>
                                                    <Image Source="{Binding ReversePath, Converter={x:Static converters:PathToBitmapImageConverter.Instance}}" Height="150">
                                                         <Image.Style>
                                                            <Style TargetType="Image">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding HasReverse}" Value="False">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding IsCombinedImage}" Value="True">
                                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Image.Style>
                                                    </Image>
                                                </Grid>
                                            </StackPanel>
                                            
                                            <!-- Simple Overlay Checkbox (Always Visible) -->
                                            <CheckBox HorizontalAlignment="Right" VerticalAlignment="Top" Margin="2"
                                                      IsChecked="{Binding DataContext.IsFixed, RelativeSource={RelativeSource AncestorType=ListBoxItem}, Mode=OneWay}"
                                                      Command="{Binding DataContext.ToggleFixedCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                      CommandParameter="{Binding DataContext, RelativeSource={RelativeSource AncestorType=ListBoxItem}}">
                                                <CheckBox.Template>
                                                    <ControlTemplate TargetType="CheckBox">
                                                        <TextBlock Text="✔" FontSize="24" FontWeight="Bold" Cursor="Hand" ToolTip="Mark as Fixed">
                                                            <TextBlock.Effect>
                                                                <DropShadowEffect BlurRadius="2" ShadowDepth="1" Color="Black" Opacity="0.8"/>
                                                            </TextBlock.Effect>
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Foreground" Value="#DDDDDD"/> 
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=CheckBox}}" Value="True">
                                                                            <Setter Property="Foreground" Value="#4CAF50"/>
                                                                        </DataTrigger>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter Property="Foreground" Value="#AAAAAA"/> 
                                                                        </Trigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>
                                                    </ControlTemplate>
                                                </CheckBox.Template>
                                            </CheckBox>
                                        </Grid>

                                    </DataTemplate>
                                </ContentControl.ContentTemplate>
                            </ContentControl>
                            
                            
                        </StackPanel>
                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- Show Rulers when Rulers tab is selected -->
        <ListBox Grid.Column="1" 
                 Visibility="{Binding SelectedTabIndex, Converter={StaticResource TabIndexToVisibilityConverter}, ConverterParameter=1}"
                 ItemsSource="{Binding Rulers}"
                 Margin="5" Background="Transparent" 
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Focusable" Value="False"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Margin" Value="0,0,0,5"/>
                </Style>
            </ListBox.ItemContainerStyle>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Grid>
                            <!-- Group with Period (Toggleable Header) -->
                            <StackPanel Visibility="{Binding Period, Converter={StaticResource NullToVisibilityConverter}}">
                                <ToggleButton x:Name="GroupToggle" IsChecked="True" 
                                              HorizontalContentAlignment="Stretch" Cursor="Hand"
                                              Background="Transparent" BorderThickness="0" Padding="0">
                                    <ToggleButton.Template>
                                        <ControlTemplate TargetType="ToggleButton">
                                            <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                                                <ContentPresenter />
                                            </Border>
                                        </ControlTemplate>
                                    </ToggleButton.Template>
                                    
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- Association Checkbox -->
                                        <CheckBox Grid.Column="0" Margin="5,0"
                                                  VerticalAlignment="Center"
                                                  IsThreeState="True"
                                                  Command="{Binding DataContext.TogglePeriodGroupAssociationCommand, ElementName=RootWindow}"
                                                  CommandParameter="{Binding DataContext, RelativeSource={RelativeSource AncestorType=ListBoxItem}}"
                                                  ToolTip="Associate/Disassociate all rulers in this period">
                                            <CheckBox.Style>
                                                <Style TargetType="CheckBox">
                                                    <Setter Property="IsChecked" Value="{Binding DataContext.IsAssociated, RelativeSource={RelativeSource AncestorType=ListBoxItem}}"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding DataContext.IsPartiallyAssociated, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True">
                                                            <Setter Property="IsChecked" Value="{x:Null}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </CheckBox.Style>
                                        </CheckBox>
                                        
                                        <!-- Period Name -->
                                        <TextBlock Grid.Column="1" Text="{Binding Period}" FontWeight="Bold" FontSize="14" 
                                                   Foreground="#2196F3" Margin="5" VerticalAlignment="Center"/>
                                    </Grid>
                                </ToggleButton>
                                
                                <ItemsControl ItemsSource="{Binding Rulers}" Margin="10,5"
                                              Visibility="{Binding IsChecked, ElementName=GroupToggle, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderBrush="#EEE" BorderThickness="0,0,0,1" Padding="8,5">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    
                                                    <!-- Association Checkbox -->
                                                    <CheckBox Grid.Column="0" Margin="0,0,8,0"
                                                              VerticalAlignment="Center"
                                                              Command="{Binding DataContext.ToggleRulerAssociationCommand, ElementName=RootWindow}"
                                                              CommandParameter="{Binding}"
                                                              ToolTip="Associate/Disassociate this ruler">
                                                        <CheckBox.Style>
                                                            <Style TargetType="CheckBox">
                                                                <Setter Property="IsChecked" Value="False"/>
                                                                <Style.Triggers>
                                                                    <MultiDataTrigger>
                                                                        <MultiDataTrigger.Conditions>
                                                                            <Condition Binding="{Binding IssuerId, Converter={StaticResource NullToVisibilityConverter}}" Value="Visible"/>
                                                                            <Condition Binding="{Binding DataContext.SelectedIssuer, ElementName=RootWindow, Converter={StaticResource NullToVisibilityConverter}}" Value="Visible"/>
                                                                        </MultiDataTrigger.Conditions>
                                                                        <Setter Property="IsChecked" Value="True"/>
                                                                    </MultiDataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </CheckBox.Style>
                                                    </CheckBox>
                                                    
                                                    <!-- Ruler Info -->
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13"/>
                                                        <TextBlock Text="{Binding YearsText}" Foreground="#888" FontSize="11" Margin="0,2,0,0"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                            
                            <!-- Show rulers directly without period (no expander) -->
                            <ItemsControl ItemsSource="{Binding Rulers}" Margin="10"
                                          Visibility="{Binding Period, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Inverse}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- Association Checkbox -->
                                            <CheckBox Grid.Column="0" Margin="0,0,8,0"
                                                      VerticalAlignment="Center"
                                                      Command="{Binding DataContext.ToggleRulerAssociationCommand, ElementName=RootWindow}"
                                                      CommandParameter="{Binding}"
                                                      ToolTip="Associate/Disassociate this ruler">
                                                <CheckBox.Style>
                                                    <Style TargetType="CheckBox">
                                                        <Setter Property="IsChecked" Value="False"/>
                                                        <Style.Triggers>
                                                            <MultiDataTrigger>
                                                                <MultiDataTrigger.Conditions>
                                                                    <Condition Binding="{Binding IssuerId, Converter={StaticResource NullToVisibilityConverter}}" Value="Visible"/>
                                                                    <Condition Binding="{Binding DataContext.SelectedIssuer, ElementName=RootWindow, Converter={StaticResource NullToVisibilityConverter}}" Value="Visible"/>
                                                                </MultiDataTrigger.Conditions>
                                                                <Setter Property="IsChecked" Value="True"/>
                                                            </MultiDataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </CheckBox.Style>
                                            </CheckBox>
                                            
                                            <!-- Ruler Info -->
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="13"/>
                                                <TextBlock Text="{Binding YearsText}" Foreground="#888" FontSize="11" Margin="0,2,0,0"/>
                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
        </Grid>

        <!-- Right Panel: Split View -->
        <Grid Grid.Column="2" x:Name="RightPanel">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="3*" /> <!-- Browser -->
                <ColumnDefinition Width="1*" />  <!-- Parse Panel -->
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/> <!-- Bottom list -->
            </Grid.RowDefinitions>

            <!-- Browser Area (Column 0, Row 0) -->
            <Grid Grid.Column="0" Grid.Row="0">
                <wv2:WebView2 Source="{Binding HtmlSource}" Margin="0,35,0,0" />
            
                <!-- Import Bar Overlay (at top of HTML view) -->
                <Border VerticalAlignment="Top" Background="#F5F5F5" BorderBrush="#CCCCCC" 
                        BorderThickness="0,0,0,1" Padding="5" Height="35" Panel.ZIndex="1">
                    <StackPanel Orientation="Horizontal">
                        <Button Command="{Binding ImportFromUcoinCommand}" Padding="15,2" Margin="5,0,0,0" Cursor="Hand" ToolTip="Import data from ucoin system">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Import from ucoin" Margin="0,0,5,0"/>
                                    <Viewbox Width="16" Height="16">
                                        <Path Data="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" Fill="#2196F3" />
                                    </Viewbox>
                                </StackPanel>
                            </Button.Content>
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="White"/>
                                    <Setter Property="BorderBrush" Value="#AAAAAA"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value="0.5"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#E3F2FD"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Command="{Binding ChangeCoinAttributesCommand}" Padding="15,2" Margin="5,0,0,0" Cursor="Hand" ToolTip="Change Coin Attributes">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Change Attributes" Margin="0,0,5,0"/>
                                    <Viewbox Width="16" Height="16">
                                        <Path Data="M17,17H7V7H17M21,7A2,2 0 0,0 19,5H5A2,2 0 0,0 3,7V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7Z" Fill="#2196F3" />
                                    </Viewbox>
                                </StackPanel>
                            </Button.Content>
                        </Button>

                    </StackPanel>
                </Border>
            </Grid>

            <!-- Parse Panel Content (Sidebar) -->
            <Grid Grid.Column="1" Grid.Row="0" Margin="10,0,0,0" Visibility="{Binding ParsedData, Converter={StaticResource NullToVisibilityConverter}}">
                 <Grid.RowDefinitions>
                     <RowDefinition Height="Auto"/>
                     <RowDefinition Height="*"/>
                 </Grid.RowDefinitions>

                 <!-- Title & Subtitle -->
                 <StackPanel Grid.Row="0" Margin="0,5,0,10">
                     <TextBlock Text="{Binding ParsedData.Title}" FontSize="14" FontWeight="Bold" TextWrapping="Wrap" Margin="0,0,0,2"/>
                     <TextBlock Text="{Binding ParsedData.Subtitle}" FontSize="11" Foreground="#555" TextWrapping="Wrap" FontStyle="Italic"/>
                 </StackPanel>

                 <!-- Content Stack (Vertical Scroll) -->
                 <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                     <StackPanel>
                         <!-- Raw Values -->
                         <GroupBox Header="Raw Values" Margin="0,0,0,10">
                             <Grid>
                                 <Grid.Resources>
                                     <Style TargetType="TextBlock">
                                         <Setter Property="FontSize" Value="11"/>
                                         <Setter Property="VerticalAlignment" Value="Center"/>
                                         <Setter Property="Padding" Value="2"/>
                                     </Style>
                                     <Style TargetType="TextBlock" x:Key="RawLabel">
                                         <Setter Property="Foreground" Value="#666666"/>
                                         <Setter Property="Margin" Value="0,0,5,0"/>
                                     </Style>
                                     <Style TargetType="TextBlock" x:Key="RawValue">
                                         <Setter Property="FontWeight" Value="SemiBold"/>
                                         <Setter Property="TextWrapping" Value="Wrap"/>
                                     </Style>
                                 </Grid.Resources>
                                 
                                 <Grid.ColumnDefinitions>
                                     <ColumnDefinition Width="Auto" SharedSizeGroup="RawLabels"/>
                                     <ColumnDefinition Width="*"/>
                                 </Grid.ColumnDefinitions>
                                 
                                 <Grid.RowDefinitions>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                     <RowDefinition Height="Auto"/>
                                 </Grid.RowDefinitions>

                                 <!-- Rows -->
                                 <TextBlock Grid.Row="0" Grid.Column="0" Text="Issuer:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding ParsedData.Issuer}" Style="{StaticResource RawValue}"/>

                                 <TextBlock Grid.Row="1" Grid.Column="0" Text="Year:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding ParsedData.YearText}" Style="{StaticResource RawValue}"/>

                                 <TextBlock Grid.Row="2" Grid.Column="0" Text="Value:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding ParsedData.ValueText}" Style="{StaticResource RawValue}"/>

                                 <TextBlock Grid.Row="3" Grid.Column="0" Text="Currency:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding ParsedData.CurrencyText}" Style="{StaticResource RawValue}"/>

                                 <TextBlock Grid.Row="4" Grid.Column="0" Text="Composition:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding ParsedData.Composition}" Style="{StaticResource RawValue}"/>

                                 <TextBlock Grid.Row="5" Grid.Column="0" Text="Weight:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding ParsedData.WeightText}" Style="{StaticResource RawValue}"/>

                                 <TextBlock Grid.Row="6" Grid.Column="0" Text="Diameter:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding ParsedData.DiameterText}" Style="{StaticResource RawValue}"/>

                                 <TextBlock Grid.Row="7" Grid.Column="0" Text="Thickness:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="7" Grid.Column="1" Text="{Binding ParsedData.ThicknessText}" Style="{StaticResource RawValue}"/>

                                 <TextBlock Grid.Row="8" Grid.Column="0" Text="Shape:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="8" Grid.Column="1" Text="{Binding ParsedData.Shape}" Style="{StaticResource RawValue}"/>

                                 <TextBlock Grid.Row="9" Grid.Column="0" Text="Orientation:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="9" Grid.Column="1" Text="{Binding ParsedData.Orientation}" Style="{StaticResource RawValue}"/>

                                 <TextBlock Grid.Row="10" Grid.Column="0" Text="References:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="10" Grid.Column="1" Text="{Binding ParsedData.References}" Style="{StaticResource RawValue}"/>
                                 
                                 <TextBlock Grid.Row="11" Grid.Column="0" Text="Ruler ID:" Style="{StaticResource RawLabel}"/>
                                 <TextBlock Grid.Row="11" Grid.Column="1" Text="{Binding ParsedData.RulerId}" Style="{StaticResource RawValue}"/>
                             </Grid>
                         </GroupBox>

                         <!-- Cleaned Data -->
                         <GroupBox Header="Cleaned Data">
                             <StackPanel>
                                 <!-- DB Verified Ruler -->
                                 <StackPanel Visibility="{Binding ParsedData.IsRulerVerified, Converter={StaticResource BooleanToVisibilityConverter}}">
                                      <TextBlock Text="DB VERIFIED RULER:" FontWeight="Bold" FontSize="11" Foreground="Green" Margin="0,0,0,5"/>
                                      <TextBlock Text="{Binding ParsedData.DbRulerName}" FontSize="12" FontWeight="SemiBold" TextWrapping="Wrap"/>
                                      <TextBlock Text="{Binding ParsedData.DbRulerYears}" FontSize="11" Foreground="#666" Margin="0,2,0,10"/>
                                 </StackPanel>

                                 <!-- Inspection Warning -->
                                 <StackPanel Visibility="{Binding ParsedData.NeedsInspection, Converter={StaticResource BooleanToVisibilityConverter}}">
                                     <TextBlock Text="⚠️ INSPECTION REQUIRED" Foreground="#D32F2F" FontWeight="Bold" Margin="0,0,0,5"/>
                                     <TextBlock Text="Ruler ID found in HTML matches no ruler for this issuer in DB." TextWrapping="Wrap" FontSize="11"/>
                                 </StackPanel>

                                 <!-- Verified Dimensions -->
                                 <StackPanel Margin="0,8,0,0">
                                      <!-- DB Verified Shape -->
                                      <StackPanel Orientation="Horizontal" Margin="0,0,0,5"
                                                  Visibility="{Binding ParsedData.DbShapeId, Converter={StaticResource NullToVisibilityConverter}}">
                                          <TextBlock Text="DB VERIFIED SHAPE:" FontWeight="Bold" FontSize="11" Foreground="Green" Margin="0,0,5,0"/>
                                          <TextBlock Text="{Binding ParsedData.DbShapeId}" FontWeight="Bold" FontSize="11" Foreground="Green"/>
                                      </StackPanel>

                                      <!-- Alarm -->
                                      <TextBlock Text="{Binding ParsedData.DimensionAlarmMessage}"
                                                 Visibility="{Binding ParsedData.HasDimensionAlarm, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                 Foreground="#D32F2F" FontWeight="Bold" FontSize="11" TextWrapping="Wrap" Margin="0,0,0,4"/>
                                      
                                      <!-- Header + Values Inline -->
                                      <TextBlock FontSize="12">
                                          <Run Text="Dimensions (mm/g) " FontSize="10" Foreground="#888888" BaselineAlignment="Center"/>
                                          <LineBreak/>
                                          <Run Text="W:" Foreground="#666666" FontSize="11"/> <Run Text="{Binding ParsedData.DecimalWeight, TargetNullValue='-'}" FontWeight="SemiBold"/>
                                          <Run Text=" D:" Foreground="#666666" FontSize="11"/> <Run Text="{Binding ParsedData.DecimalDiameter, TargetNullValue='-'}" FontWeight="SemiBold"/>
                                          <Run Text=" T:" Foreground="#666666" FontSize="11"/> <Run Text="{Binding ParsedData.DecimalThickness, TargetNullValue='-'}" FontWeight="SemiBold"/>
                                      </TextBlock>
                                 </StackPanel>
                             </StackPanel>
                         </GroupBox>
                     </StackPanel>
                 </ScrollViewer>
            </Grid>

            <!-- Non-Reference Samples List -->
            <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Background="#E0E0E0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Toolbox Stripe -->
                <Border Grid.Row="0" Background="#EEEEEE" BorderBrush="#CCCCCC" BorderThickness="0,0,0,1" Padding="3">
                    <StackPanel Orientation="Horizontal">
                        <Button Command="{Binding SplitSampleCommand}" Padding="15,2" Margin="5,0,0,0" Cursor="Hand">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Split" Margin="0,0,5,0"/>
                                    <Ellipse Width="8" Height="8" Fill="Red"/>
                                </StackPanel>
                            </Button.Content>
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="White"/>
                                    <Setter Property="BorderBrush" Value="#AAAAAA"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value="0.5"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#F0F8FF"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>

                        

                        
                        <Button Command="{Binding SwapSampleCommand}" Padding="15,2" Margin="10,0,0,0" Cursor="Hand">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Swap" Margin="0,0,5,0"/>
                                    <Ellipse Width="8" Height="8" Fill="#40E0D0"/>
                                </StackPanel>
                            </Button.Content>
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="White"/>
                                    <Setter Property="BorderBrush" Value="#AAAAAA"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value="0.5"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#F0F8FF"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Command="{Binding ChooseBestSampleCommand}" Padding="15,2" Margin="10,0,0,0" Cursor="Hand">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Choose" Margin="0,0,5,0"/>
                                    <Ellipse Width="8" Height="8" Fill="#9370DB"/>
                                </StackPanel>
                            </Button.Content>
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="White"/>
                                    <Setter Property="BorderBrush" Value="#AAAAAA"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value="0.5"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#F0F8FF"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Command="{Binding PromoteSampleCommand}" Padding="15,2" Margin="10,0,0,0" Cursor="Hand" ToolTip="Promote to Main Reference">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Promote" Margin="0,0,5,0"/>
                                    <Viewbox Width="16" Height="16">
                                        <Path Data="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" Fill="#4CAF50" />
                                    </Viewbox>
                                </StackPanel>
                            </Button.Content>
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="White"/>
                                    <Setter Property="BorderBrush" Value="#AAAAAA"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value="0.5"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#F0F8FF"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>

                        <Button Command="{Binding DeleteSampleCommand}" Padding="15,2" Margin="10,0,0,0" Cursor="Hand" ToolTip="Delete Sample (Past Sales Only)">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Delete" Margin="0,0,5,0"/>
                                    <Viewbox Width="16" Height="16">
                                        <Path Data="M9,3V4H4V6H5V19C5,20.1 5.9,21 7,21H17C18.1,21 19,20.1 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z" Fill="#FF4444" />
                                    </Viewbox>
                                </StackPanel>
                            </Button.Content>
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="White"/>
                                    <Setter Property="BorderBrush" Value="#AAAAAA"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value="0.5"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#FFEBEE"/> <!-- Light Red Hover -->
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>

                        <Button Command="{Binding TransferSampleCommand}" Padding="15,2" Margin="10,0,0,0" Cursor="Hand" ToolTip="Transfer Sample to Different Coin Type">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Transfer" Margin="0,0,5,0"/>
                                    <Viewbox Width="16" Height="16">
                                        <Path Data="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19C3,20.1 3.9,21 5,21H19C20.1,21 21,20.1 21,19V12H19V19Z" Fill="#2196F3" />
                                    </Viewbox>
                                </StackPanel>
                            </Button.Content>
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="White"/>
                                    <Setter Property="BorderBrush" Value="#AAAAAA"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value="0.5"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#E3F2FD"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>

                        <Button Command="{Binding MarkAsSampleCommand}" Padding="15,2" Margin="10,0,0,0" Cursor="Hand" ToolTip="Mark Sample with Category">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Mark As" Margin="0,0,5,0"/>
                                    <Viewbox Width="16" Height="16">
                                        <Path Data="M5.5,7A1.5,1.5 0 0,1 4,5.5A1.5,1.5 0 0,1 5.5,4A1.5,1.5 0 0,1 7,5.5A1.5,1.5 0 0,1 5.5,7M21.41,11.58L12.41,2.58C12.05,2.22 11.55,2 11,2H4C2.89,2 2,2.89 2,4V11C2,11.55 2.22,12.05 2.59,12.41L11.58,21.41C11.95,21.77 12.45,22 13,22C13.55,22 14.05,21.77 14.41,21.41L21.41,14.41C21.77,14.05 22,13.55 22,13C22,12.45 21.77,11.95 21.41,11.58Z" Fill="#FF9800" />
                                    </Viewbox>
                                </StackPanel>
                            </Button.Content>
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="White"/>
                                    <Setter Property="BorderBrush" Value="#AAAAAA"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value="0.5"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#FFF3E0"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>

                    </StackPanel>
                </Border>

                <TextBlock Grid.Row="1" Text="No Samples Available" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="Gray"
                           Visibility="{Binding SelectedCoin.Samples, Converter={x:Static converters:NullOrEmptyToVisibilityConverter.Instance}}" />
                
                 <ListBox Grid.Row="1" ItemsSource="{Binding SelectedCoin.Samples}" 
                          SelectedItem="{Binding SelectedSample}"
                          SelectionMode="Extended"
                          SelectionChanged="ListBox_SelectionChanged"
                          Background="Transparent" BorderThickness="0"
                          PreviewKeyDown="ListBox_PreviewKeyDown"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto" ScrollViewer.VerticalScrollBarVisibility="Disabled">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <EventSetter Event="MouseDoubleClick" Handler="ListBoxItem_MouseDoubleClick"/>
                            <Setter Property="Padding" Value="4"/>
                            <Setter Property="Margin" Value="2,4"/> <!-- Spacing between items -->
                            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                            
                            <!-- Default State: Grey Background, Dark Grey Border -->
                            <Setter Property="Background" Value="#E0E0E0"/> 
                            <Setter Property="BorderBrush" Value="#A0A0A0"/>
                            <Setter Property="BorderThickness" Value="2"/>

                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border Background="{TemplateBinding Background}"
                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                CornerRadius="4"
                                                SnapsToDevicePixels="True">
                                            <ContentPresenter />
                                        </Border>
                                        <ControlTemplate.Triggers>
                                             <Trigger Property="IsMouseOver" Value="True">
                                                  <Setter Property="Background" Value="#ECECEC"/>
                                             </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="#CCE8FF"/> 
                                    <Setter Property="BorderBrush" Value="#99CCFF"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="{x:Type models:CoinSample}">
                                <Border Margin="0" Background="Transparent">
                                    <Grid>
                                        <StackPanel Orientation="Horizontal" Margin="0">
                                        <Grid Margin="0,0,5,0">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <Image Grid.Row="0" Name="ItemObvImg" Source="{Binding ObversePath, Converter={x:Static converters:PathToBitmapImageConverter.Instance}}" Height="120">
                                                <Image.InputBindings>
                                                    <MouseBinding Gesture="Alt+LeftClick" Command="{Binding DataContext.ViewFullImageCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding ObversePath}" />
                                                </Image.InputBindings>
                                            </Image>
                                            
                                            <Canvas Grid.Row="0" Width="{Binding ActualWidth, ElementName=ItemObvImg}" Height="{Binding ActualHeight, ElementName=ItemObvImg}">
                                                <Canvas.Style>
                                                    <Style TargetType="Canvas">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsCombinedImage}" Value="True">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Canvas.Style>
                                                <Line Y1="0" Y2="{Binding ActualHeight, ElementName=ItemObvImg}" Stroke="Red" StrokeThickness="3" StrokeDashArray="4 2">
                                                    <Line.X1>
                                                        <MultiBinding Converter="{StaticResource RatioToPixelConverter}">
                                                            <Binding Path="ActualWidth" ElementName="ItemObvImg"/>
                                                            <Binding Path="SplitRatio"/>
                                                        </MultiBinding>
                                                    </Line.X1>
                                                    <Line.X2>
                                                        <MultiBinding Converter="{StaticResource RatioToPixelConverter}">
                                                            <Binding Path="ActualWidth" ElementName="ItemObvImg"/>
                                                            <Binding Path="SplitRatio"/>
                                                        </MultiBinding>
                                                    </Line.X2>
                                                </Line>

                                                <!-- Hit Test Box for Dragging -->
                                                <Rectangle Width="15" Height="{Binding ActualHeight, ElementName=ItemObvImg}" 
                                                           Fill="Transparent" Cursor="SizeWE"
                                                           MouseLeftButtonDown="SplitLine_MouseLeftButtonDown"
                                                           MouseLeftButtonUp="SplitLine_MouseLeftButtonUp"
                                                           MouseMove="SplitLine_MouseMove"
                                                           Tag="{Binding}">
                                                     <Canvas.Left>
                                                         <MultiBinding Converter="{StaticResource RatioToPixelConverter}">
                                                            <Binding Path="ActualWidth" ElementName="ItemObvImg"/>
                                                            <Binding Path="SplitRatio"/>
                                                            <Binding Source="-7.5"/> <!-- Offset to center -->
                                                        </MultiBinding>
                                                     </Canvas.Left>
                                                </Rectangle>
                                            </Canvas>




                                            
                                            <TextBlock Grid.Row="1" Text="{Binding ObverseImage}" 
                                                       FontSize="9" Foreground="#444" 
                                                       TextWrapping="Wrap" TextAlignment="Center" 
                                                       HorizontalAlignment="Center" 
                                                       Width="{Binding ActualWidth, ElementName=ItemObvImg}" 
                                                       Margin="0,2,0,0"/>

                                            <Grid.Style>
                                                <Style TargetType="Grid">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding HasObverse}" Value="False">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Grid.Style>
                                        </Grid>

                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            
                                            <Image Grid.Row="0" Name="ItemRevImg" Source="{Binding ReversePath, Converter={x:Static converters:PathToBitmapImageConverter.Instance}}" Height="120">
                                                <Image.InputBindings>
                                                    <MouseBinding Gesture="Alt+LeftClick" Command="{Binding DataContext.ViewFullImageCommand, RelativeSource={RelativeSource AncestorType=Window}}" CommandParameter="{Binding ReversePath}" />
                                                </Image.InputBindings>
                                            </Image>
                                            
                                            <TextBlock Grid.Row="1" Text="{Binding ReverseImage}" 
                                                       FontSize="9" Foreground="#444" 
                                                       TextWrapping="Wrap" TextAlignment="Center" 
                                                       HorizontalAlignment="Center" 
                                                       Width="{Binding ActualWidth, ElementName=ItemRevImg}" 
                                                       Margin="0,2,0,0"/>



                                            <Grid.Style>
                                                <Style TargetType="Grid">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding HasReverse}" Value="False">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding IsCombinedImage}" Value="True">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Grid.Style>
                                        </Grid>
                                    </StackPanel>
                                    
                                    <!-- Swap Indicator Overlay -->
                                    <Path Data="M 10,20 L 90,20 M 80,10 L 90,20 L 80,30 M 20,10 L 10,20 L 20,30" 
                                          Stroke="#40E0D0" StrokeThickness="3" StrokeEndLineCap="Round" StrokeStartLineCap="Round" StrokeLineJoin="Round"
                                          HorizontalAlignment="Center" VerticalAlignment="Center" IsHitTestVisible="False"
                                          Visibility="{Binding IsSwapSuggested, Converter={StaticResource BooleanToVisibilityConverter}}">
                                         <Path.Effect>
                                              <DropShadowEffect Color="Black" BlurRadius="3" Opacity="0.7" ShadowDepth="1"/>
                                         </Path.Effect>
                                    </Path>

                                    <!-- Reference Indicator (Orange Triangle) - Top Left of Sample -->
                                    <Path Data="M 0,0 L 25,0 L 0,25 Z" Fill="Orange" HorizontalAlignment="Left" VerticalAlignment="Top" IsHitTestVisible="False" Margin="0">
                                        <Path.Effect>
                                            <DropShadowEffect BlurRadius="2" ShadowDepth="1" Opacity="0.5"/>
                                        </Path.Effect>
                                        <Path.Style>
                                            <Style TargetType="Path">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsReference}" Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Path.Style>
                                    </Path>

                                    <!-- Holder Indicator (Grey Square) - Top Left of Sample -->
                                    <Rectangle Width="20" Height="20" Fill="#CC808080" HorizontalAlignment="Left" VerticalAlignment="Top" IsHitTestVisible="False" Margin="0,0,0,0">
                                        <Rectangle.Effect>
                                            <DropShadowEffect BlurRadius="2" ShadowDepth="1" Opacity="0.5"/>
                                        </Rectangle.Effect>
                                        <Rectangle.Style>
                                            <Style TargetType="Rectangle">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsHolder}" Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Rectangle.Style>
                                    </Rectangle>

                                    <!-- Multi-coin Indicator (Light Blue Square) - Top Left of Sample -->
                                    <Rectangle Width="20" Height="20" Fill="#9987CEEB" HorizontalAlignment="Left" VerticalAlignment="Top" IsHitTestVisible="False" Margin="0,0,0,0">
                                        <Rectangle.Effect>
                                            <DropShadowEffect BlurRadius="2" ShadowDepth="1" Opacity="0.5"/>
                                        </Rectangle.Effect>
                                        <Rectangle.Style>
                                            <Style TargetType="Rectangle">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsMultiCoin}" Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Rectangle.Style>
                                    </Rectangle>

                                    <!-- Contains Holder Indicator (Light Lime Square) - Top Left of Sample -->
                                    <Rectangle Width="20" Height="20" Fill="#99BFFF00" HorizontalAlignment="Left" VerticalAlignment="Top" IsHitTestVisible="False" Margin="0,0,0,0">
                                        <Rectangle.Effect>
                                            <DropShadowEffect BlurRadius="2" ShadowDepth="1" Opacity="0.5"/>
                                        </Rectangle.Effect>
                                        <Rectangle.Style>
                                            <Style TargetType="Rectangle">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding ContainsHolder}" Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Rectangle.Style>
                                    </Rectangle>

                                    <!-- Fuzzy Group Indicator (Purple Badge) - Top Right of Sample -->
                                    <Border HorizontalAlignment="Right" VerticalAlignment="Top" 
                                            Background="#9370DB" CornerRadius="0,4,0,4" Padding="6,2" Margin="0"
                                            Visibility="{Binding IsFuzzyGrouped, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="2" ShadowDepth="1" Opacity="0.5"/>
                                        </Border.Effect>
                                        <TextBlock Text="{Binding FuzzyGroupIndex}" Foreground="White" FontSize="11" FontWeight="Bold"/>
                                    </Border>
                                    </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                
                <!-- Blocking overlay for bottom panel during transfer mode -->
                <Border Grid.Row="1" Background="#80000000" Visibility="{Binding IsTransferModeActive, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="Select target coin from the list →" FontSize="16" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                </Border>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="1" Grid.ColumnSpan="3">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" FontWeight="Bold" Foreground="Blue" />
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
